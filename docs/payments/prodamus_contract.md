# Контракт интеграции с Prodamus (MVP)

> Важно: в текущем окружении недоступны внешние сайты Prodamus (`403` при попытке открыть `https://prodamus.ru/*` и `https://help.prodamus.ru`).
> Поэтому ниже зафиксирован рабочий контракт для проекта на основе ТЗ и текущей реализации, а также пометки что обязательно сверить в кабинете/официальной документации Prodamus перед прод-выкаткой.

## 1) Формирование платёжной ссылки

| Поле | Тип / пример | Обязательность | Источник |
|---|---|---|---|
| `order_id` | `"123"` | обязательно | реализация (`app/payments/prodamus.py`) |
| `amount` | `"990.00"` | обязательно | реализация (`app/payments/prodamus.py`) |
| `sum` | `"990.00"` | обязательно (в текущем контракте дублирует amount) | реализация (`app/payments/prodamus.py`) |
| `currency` | `"RUB"` | обязательно | реализация (`app/payments/prodamus.py`) |
| `description` | `"Тариф T1"` | обязательно | реализация (`app/payments/prodamus.py`) |
| `products[0][name]` | `"Тариф T1"` | обязательно | реализация (`app/payments/prodamus.py`) |
| `products[0][price]` | `"990.00"` | обязательно | реализация (`app/payments/prodamus.py`) |
| `products[0][quantity]` | `"1"` | обязательно | реализация (`app/payments/prodamus.py`) |
| `products[0][sum]` | `"990.00"` | обязательно | реализация (`app/payments/prodamus.py`) |
| `do` | `"link"` | условно обязательно (когда используется API-ключ) | реализация (`app/payments/prodamus.py`) |
| `key` | `"<api_key>"` | условно обязательно (когда используется API-ключ) | реализация (`app/payments/prodamus.py`) |
| `callback_url` | `"https://bot.example/webhooks/payments"` | обязательно для backend-потока оплаты | ТЗ + реализация |
| `success_url` | `"https://example.com/payments/success"` | опционально (редирект при успешной оплате) | реализация (`app/payments/prodamus.py`) |
| `fail_url` | `"https://example.com/payments/fail"` | опционально (редирект при ошибке/отмене оплаты) | реализация (`app/payments/prodamus.py`) |
| `customer_id` | `"123456789"` | опционально | реализация (`app/payments/prodamus.py`) |
| `customer_username` | `"username"` | опционально | реализация (`app/payments/prodamus.py`) |

### Что обязательно сверить в кабинете Prodamus
- Набор реально обязательных полей среди `order_id` и `amount`/`sum`.
- Требуется ли строго `products` для платёжной формы в вашем тарифе/типе интеграции.
- Нужен ли отдельный параметр успеха/неуспеха редиректа (если используется).

## 2) Webhook-уведомление

| Поле | Тип / пример | Обязательность | Источник |
|---|---|---|---|
| `order_id` (или `order`) | `"123"` | обязательно | реализация (`_extract_webhook`) |
| `status` (или `payment_status`) | `"paid"` | обязательно для определения оплаты | реализация (`_extract_webhook`, `_is_paid_status`) |
| `payment_id` (или `transaction_id`) | `"p-1"` | желательно (идентификатор операции) | реализация (`_extract_webhook`) |
| Подпись (`X-Prodamus-Signature` / `X-Signature` / `X-Webhook-Signature` / `signature` / `sign`) | строка | обязательно при включённой проверке секрета | реализация (`verify_webhook`) |
| `token` | строка | условно обязательно (если используется MD5-вариант подписи token+secret) | реализация (`_signature_candidates`) |

## 3) Запрос статуса оплаты

| Поле | Тип / пример | Обязательность | Источник |
|---|---|---|---|
| `order_id` | `"123"` | обязательно | реализация (`check_payment_status`) |
| `secret` | `"<secret>"` | обязательно | реализация (`check_payment_status`) |

Ожидаемые поля ответа (минимум для нашей логики):
- `status` или `payment_status` (или `result.status`),
- `payment_id` или `transaction_id` (или `result.payment_id` / `result.transaction_id`).

## 4) Алгоритм подписи webhook (как сейчас в проекте)

### Основной (каноничный) алгоритм
1. Из payload берётся `token`.
2. Считается `md5(token + secret)`.
3. Подпись валидна, если присланная подпись совпала с этим значением (без учёта регистра).

> Это основной путь проверки и он приоритетен.

### Fallback-алгоритмы (legacy) и условия применения
Fallback запускается **только** если одновременно выполняются условия:
- каноничный `md5(token + secret)` не совпал;
- подпись пришла именно в заголовке (`X-Prodamus-Signature` / `X-Signature` / `X-Webhook-Signature`), а не в payload;
- webhook secret (`PRODAMUS_WEBHOOK_SECRET` или fallback `PRODAMUS_API_KEY`) задан.

В таком режиме принимаются только legacy-варианты:
1. `HMAC-SHA256(secret, raw_body)` в hex;
2. `HMAC-SHA256(secret, raw_body)` в base64;
3. `SHA256(raw_body + secret)` в hex.

### Какой секрет используется
- Для webhook: `PRODAMUS_WEBHOOK_SECRET`, при отсутствии — fallback на `PRODAMUS_API_KEY`.
- Для запроса статуса оплаты: `PRODAMUS_SECRET`, при отсутствии — fallback на `PRODAMUS_API_KEY`.

## 5) Расхождения с текущей реализацией (`app/payments/prodamus.py`)

1. **Нет единого канонического алгоритма подписи по официальной схеме Prodamus.**
   Реализация принимает сразу несколько вариантов (`HMAC hex`, `HMAC base64`, `MD5(token+secret)`), что повышает совместимость, но может расходиться с официальным контрактом конкретного кабинета.

2. **Подпись ищется в нескольких заголовках и полях payload одновременно.**
   Это удобно для миграций, но может быть избыточным и менее строгим, чем требуется в проде.

3. **Платёжная ссылка отправляет дублирующие сумму поля (`amount` + `sum`).**
   Такое поведение работает как «универсальный» вариант, но нуждается в сверке с официально обязательным минимумом.

4. **Проверка статуса оплаты завязана только на `order_id` + `secret`.**
   Если в кабинете Prodamus для статуса требуются дополнительные реквизиты (например, ключ проекта/подпись), текущую реализацию надо расширить.

5. **Fallback на `PRODAMUS_API_KEY` как универсальный секрет.**
   Это практично для MVP, но в прод-среде лучше разделить секреты по назначению (form key / webhook secret / status secret) без fallback.

## 6) Проверка перед прод-выкаткой (обязательный чек-лист)

1. Сверить таблицы выше с официальной документацией Prodamus и параметрами именно вашего кабинета.
2. Зафиксировать один канонический алгоритм подписи webhook и убрать лишние fallback-варианты.
3. Протестировать sandbox/боевые webhook с реальными событиями `paid` и `failed`.
4. Проверить, что статусный endpoint действительно принимает `order_id` + `secret` в JSON.
5. После сверки обновить этот файл и добавить ссылку на конкретный раздел документации Prodamus.
