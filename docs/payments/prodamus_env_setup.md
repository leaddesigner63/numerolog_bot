# Настройка обязательных переменных окружения для Prodamus

Документ описывает обязательные переменные окружения для работы платёжного потока с провайдером Prodamus.

## Обязательные переменные

### `PAYMENT_PROVIDER`
- **Где взять значение:** инфраструктура проекта (файл `.env`, секреты CI/CD, переменные окружения сервера).
- **Назначение:** определяет, какой платёжный провайдер используется приложением.
- **Пример формата:** `prodamus`
- **Если значение пустое:** приложение не сможет выбрать платёжный backend; создание платёжной ссылки и обработка оплаты будут недоступны.

### `PRODAMUS_FORM_URL`
- **Где взять значение:** кабинет Prodamus / документация вашего аккаунта Prodamus (URL платёжной формы).
- **Назначение:** базовый URL, на который формируется ссылка для перехода пользователя к оплате.
- **Пример формата:** `https://payform.prodamus.ru/` или URL, выданный вашим аккаунтом.
- **Если значение пустое:** не получится сгенерировать валидную ссылку на оплату, пользователь не сможет перейти к форме оплаты.

### `PRODAMUS_API_KEY`
- **Где взять значение:** кабинет Prodamus (API-ключ интеграции).
- **Назначение:** используется для авторизованных запросов к API Prodamus (если включены API-вызовы в вашей схеме интеграции).
- **Пример формата:** `pdm_live_xxxxxxxxxxxxxxxxxxxx`
- **Если значение пустое:** API-запросы к Prodamus будут отклоняться, операции создания/проверки платежей могут не работать.

### `PRODAMUS_SECRET`
- **Где взять значение:** кабинет Prodamus (секретный ключ для подписи/проверки подписи).
- **Назначение:** используется для формирования и/или проверки криптографической подписи данных платежа.
- **Пример формата:** `c9f36f2a8c4d4f6b9b26d12e76ad4f90`
- **Если значение пустое:** невозможно корректно подписать запросы или проверить достоверность ответов, платёжный flow становится небезопасным и должен блокироваться.

### `PRODAMUS_WEBHOOK_SECRET`
- **Где взять значение:** кабинет Prodamus (секрет webhook-уведомлений), либо согласованное значение в настройках webhook у провайдера.
- **Назначение:** валидация входящих webhook-уведомлений о статусе платежа.
- **Пример формата:** `whsec_7f2f88f53fda4f1d9f2db2f9a1a3b7d3`
- **Если значение пустое:** нельзя безопасно подтвердить источник webhook, автоматическое подтверждение оплаты должно считаться недоверенным и отключаться.

### `PRODAMUS_STATUS_URL`
- **Где взять значение:** кабинет Prodamus / документация API (endpoint проверки статуса платежа).
- **Назначение:** URL для серверной проверки статуса транзакции.
- **Пример формата:** `https://api.prodamus.ru/payments/status`
- **Если значение пустое:** резервная проверка статуса платежа недоступна; система не сможет сверять статусы при спорных или пропущенных webhook.

### `PAYMENT_WEBHOOK_URL`
- **Где взять значение:** инфраструктура проекта (публичный HTTPS-адрес вашего backend-эндпоинта webhook).
- **Назначение:** URL, который передаётся в настройках провайдера для получения уведомлений об оплате.
- **Пример формата:** `https://bot.example.com/api/payments/prodamus/webhook`
- **Если значение пустое:** провайдеру некуда отправлять уведомления; платежи не будут автоматически подтверждаться в приложении.

## Режим с одним ключом (ваш кейс)

Если Prodamus выдал только один ключ, в MVP можно работать в режиме единого секрета:

- задайте `PRODAMUS_KEY=<ваш_ключ>`;
- `PRODAMUS_API_KEY`, `PRODAMUS_SECRET`, `PRODAMUS_WEBHOOK_SECRET` можно не заполнять;
- приложение автоматически использует `PRODAMUS_KEY` и для генерации ссылки, и для проверки webhook, и для status-check.

Важно: если webhook приходит без подписи, допускается payload-вариант с полем секрета (`secret`/`webhook_secret`/`callback_secret`) равным `PRODAMUS_KEY`.

## Проверка после настройки (smoke flow)

1. Убедитесь, что все перечисленные переменные заданы в runtime-окружении (`.env`, secrets в CI/CD, secrets оркестратора).
2. Перезапустите backend-приложение и проверьте, что сервис поднимается без ошибок конфигурации.
3. Создайте тестовый заказ в приложении (тариф с оплатой) и получите ссылку на оплату.
4. Откройте ссылку и выполните тестовый платёж в среде/режиме, разрешённом вашим аккаунтом Prodamus.
5. Проверьте, что webhook от Prodamus пришёл на `PAYMENT_WEBHOOK_URL`, подпись успешно верифицирована через `PRODAMUS_WEBHOOK_SECRET`, а заказ переведён в статус `paid`.
6. Дополнительно выполните серверную сверку статуса через `PRODAMUS_STATUS_URL` и убедитесь, что статус совпадает с webhook.
7. Убедитесь, что после подтверждения оплаты запускается следующий шаг продуктового сценария (например, переход к сбору данных пользователя или генерации результата).
8. Зафиксируйте результат smoke-проверки в журнале релиза: дата, окружение, `order_id`, итоговый статус.

## Рекомендации по эксплуатации

- Никогда не храните ключи (`PRODAMUS_API_KEY`, `PRODAMUS_SECRET`, `PRODAMUS_WEBHOOK_SECRET`) в репозитории в открытом виде.
- Разделяйте тестовые и боевые ключи по окружениям (`dev/stage/prod`).
- Включите мониторинг 4xx/5xx для webhook-эндпоинта и алерт на отсутствие webhook-событий.
- Используйте ротацию секретов по регламенту безопасности и проверяйте работоспособность smoke flow после каждой ротации.
